<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>星痕共鸣实时战斗数据</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            margin: 0;
            text-align: center;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .button-container {
            margin-bottom: 15px;
            overflow: visible;
            position: relative;
            width: 100%;
            display: flex;
            justify-content: space-between;
        }

        .button-group {
            display: flex;
        }

        button {
            margin: 0 5px 0 0;
            padding: 5px 10px;
            font-size: 14px;
            border-radius: 4px;
            background-color: #4b4b4b29;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #030303;
        }

        .card {
            margin: 0 auto;
            margin-top: 10px;
            background: rgba(125, 125, 125, 0.5);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background-color: #2103033c;
            font-weight: bold;
            padding: 8px 5px;
            position: sticky;
            top: 0;
            transition: background-color 0.3s ease;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }
        
        td {
            padding: 6px 5px;
            text-align: center;
            position: relative;
            z-index: 1;
            
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            opacity: 0.8;
        }
        
        tr {
            position: relative;
        }
        
        tr:nth-child(even) {
            background-color: #25252513;
        }

        tr:hover {
            background-color: #3a3a3a29;
        }

        .dropdown-wrapper {
            position: relative;
            display: inline-block;
        }

        .dropdown-btn {
            height: 30px;
            padding: 5px 10px;
            font-size: 14px;
            background-color: #4b4b4b29;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }

        .dropdown-btn:hover {
            background-color: #030303;
        }

        .dropdown-container {
            position: absolute;
            top: 100%;
            right: 0;
            display: none;
            z-index: 1000;
            margin-top: 5px;
        }

        .dropdown-content {
            background-color: #4b4b4b;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .dropdown-content a {
            color: white;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            font-size: 14px;
            text-align: left;
            white-space: nowrap;
        }

        .dropdown-content a:hover {
            background-color: #030303;
        }

        .dropdown-wrapper:hover .dropdown-container {
            display: block;
        }
        
        .percentage-row-background-dps {
            position: absolute;
            top: 0;
            left: 0;
            margin: 5px 0 5px 0;
            height: 70%;
            border-radius: 4px;
            background-color: #ffd700;
            opacity: 0.2;
            transition: width 0.3s ease-in-out;
            z-index: 0;
        }
        
        .percentage-row-background-hps {
            position: absolute;
            top: 0;
            left: 0;
            margin: 5px 0 5px 0;
            height: 70%;
            border-radius: 4px;
            background-color: #00ff06;
            opacity: 0.2;
            transition: width 0.3s ease-in-out;
            z-index: 0;
        }
        
        .percentage-text {
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }
        .trhzb {
            width: 0;
        }
    </style>
</head>

<body>
    <div class="button-container">
        <div class="button-group">
            <button onclick="clearData()">清空数据</button>
        </div>
        <div class="dropdown-wrapper">
            <button class="dropdown-btn" id="dropdownBtn">排序方式 ▼</button>
            <div class="dropdown-container">
                <div class="dropdown-content">
                    <a href="#" onclick="changeSortMode('uid')">按UID排序</a>
                    <a href="#" onclick="changeSortMode('damage')">按总伤害排序</a>
                    <a href="#" onclick="changeSortMode('dps')">按DPS/HPS排序</a>
                    <a href="#" onclick="changeSortMode('realtimeDpsMax')">按最大瞬时排序</a>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <table id="damageTable">
            <thead>
                <tr>
                    <th></th>
                    <th></th>
                    <th title="角色唯一标识符和职业名称">ID</th>
                    <th title="角色在战斗中造成的总伤害">总伤害</th>
                    <th title="角色在战斗中承受的总伤害">承伤</th>
                    <th title="角色在战斗中的暴击触发率">暴击率</th>
                    <th title="角色在战斗中的幸运触发率">幸运率</th>
                    <th title="角色在战斗中的暴幸触发率">暴幸率</th>
                    <th title="角色在战斗中的最大瞬时DPS">最大DPS</th>
                    <th title="角色在战斗中的总DPS">总DPS</th>
                    <th title="根据排序模式计算的占比">占比</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="card">
        <table id="healTable">
            <thead>
                <tr>
                    <th></th>
                    <th></th>
                    <th title="角色唯一标识符和职业名称">ID</th>
                    <th title="角色在战斗中造成的总治疗">总治疗</th>
                    <th title="角色在战斗中的暴击触发率">暴击率</th>
                    <th title="角色在战斗中的幸运触发率">幸运率</th>
                    <th title="角色在战斗中的暴幸触发率">暴幸率</th>
                    <th title="角色在战斗中的最大瞬时HPS">最大HPS</th>
                    <th title="角色在战斗中的总HPS">总HPS</th>
                    <th title="根据排序模式计算的占比">占比</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
        let currentSortMode = localStorage.getItem('sortMode') || 'dps';

        async function fetchDataAndUpdateTables() {
            try {
                const res = await fetch('/api/data');
                const data = await res.json();
                const damageTable = document.getElementById('damageTable').querySelector('tbody');
                const healTable = document.getElementById('healTable').querySelector('tbody');
                damageTable.innerHTML = '';
                healTable.innerHTML = '';

                const userArray = Object.keys(data.user).map(id => ({
                    id: Number(id),
                    ...data.user[id]
                }));

                const dpsUserArray = [...userArray];
                const hpsUserArray = [...userArray];
                
                sortUserArray(dpsUserArray, 'dps');
                sortUserArray(hpsUserArray, 'hps');

                let totalDamage = 0;
                let topDps = 0;
                let totalHealing = 0;
                let topHps = 0;

                if (dpsUserArray.length > 0) {
                    if (currentSortMode === 'damage') {
                        totalDamage = dpsUserArray.reduce((sum, user) => sum + (user.total_damage ? user.total_damage.total : 0), 0);
                    } else if (currentSortMode === 'dps') {
                        topDps = dpsUserArray.length > 0 && dpsUserArray.some(user => user.total_dps !== undefined) ? dpsUserArray.reduce((max, user) => Math.max(max, user.total_dps || 0), 0) : 0;
                        topHps = hpsUserArray.length > 0 && hpsUserArray.some(user => user.total_hps !== undefined) ? hpsUserArray.reduce((max, user) => Math.max(max, user.total_hps || 0), 0) : 0;
                    } else if (currentSortMode === 'realtimeDpsMax') {
                        topDps = dpsUserArray.length > 0 && dpsUserArray.some(user => user.realtime_dps_max !== undefined) ? dpsUserArray.reduce((max, user) => Math.max(max, user.realtime_dps_max || 0), 0) : 0;
                        topHps = hpsUserArray.length > 0 && hpsUserArray.some(user => user.realtime_hps_max !== undefined) ? hpsUserArray.reduce((max, user) => Math.max(max, user.realtime_hps_max || 0), 0) : 0;
                    }
                    totalHealing = hpsUserArray.reduce((sum, user) => sum + (user.total_healing ? user.total_healing.total : 0), 0);
                }

                // Populate Damage Table
                for (const user of dpsUserArray) {
                    const professionName = user.profession || '未知';
                    const damageData = user.total_damage || { total: 0 };
                    const damageCounts = user.damage_counts || { total: 0, critical: 0, lucky: 0, crit_lucky: 0 };
                    
                    if (damageData.total > 0) {
                        const damage_crit_rate = damageCounts.total > 0 ? damageCounts.critical / damageCounts.total : 0;
                        const damage_lucky_rate = damageCounts.total > 0 ? damageCounts.lucky / damageCounts.total : 0;
                        const damage_crit_lucky_rate = damageCounts.total > 0 ? damageCounts.crit_lucky / damageCounts.total : 0;

                        const totalDamageValue = damageData.total;
                        const takenDamageValue = user.taken_damage || 0;
                        const realtimeDpsMax = user.realtime_dps_max || 0;
                        const totalDps = user.total_dps || 0;

                        let percentage = 0;
                        let percentageText = '';
                        if (currentSortMode === 'damage' && totalDamage > 0) {
                            percentage = (totalDamageValue / totalDamage) * 100;
                            percentageText = `${percentage.toFixed(2)}%`;
                        } else if (currentSortMode === 'dps' && topDps > 0) {
                            percentage = (totalDps / topDps) * 100;
                            percentageText = `${percentage.toFixed(2)}%`;
                        } else if (currentSortMode === 'realtimeDpsMax' && topDps > 0) {
                            percentage = (realtimeDpsMax / topDps) * 100;
                            percentageText = `${percentage.toFixed(2)}%`;
                        }
                        
                        const row = document.createElement('tr');
                        const backgroundDiv = document.createElement('div');
                        backgroundDiv.className = 'percentage-row-background-dps';
                        backgroundDiv.style.width = `${percentage}%`;
                        row.appendChild(backgroundDiv);

                        const dataColumns = [
                            `${user.id} (${professionName})`,
                            formatNumber(totalDamageValue),
                            formatNumber(takenDamageValue),
                            `${(damage_crit_rate * 100).toFixed(2)}%`,
                            `${(damage_lucky_rate * 100).toFixed(2)}%`,
                            `${(damage_crit_lucky_rate * 100).toFixed(2)}%`,
                            formatNumber(realtimeDpsMax),
                            totalDps.toFixed(2),
                            `<span class="percentage-text">${percentageText}</span>`
                        ];
                        
                        const tdBlank = document.createElement('td');
                        tdBlank.className = 'trhzb';
                        row.prepend(tdBlank);

                        dataColumns.forEach(html => {
                            const td = document.createElement('td');
                            td.innerHTML = html;
                            row.appendChild(td);
                        });
                        damageTable.appendChild(row);
                    }
                }

                // Populate Healing Table
                for (const user of hpsUserArray) {
                    const professionName = user.profession || '未知';
                    const healingData = user.total_healing || { total: 0 };
                    const healingCounts = user.healing_counts || { total: 0, critical: 0, lucky: 0, crit_lucky: 0 };
                    
                    if (healingData.total > 0) {
                        const healing_crit_rate = healingCounts.total > 0 ? healingCounts.critical / healingCounts.total : 0;
                        const healing_lucky_rate = healingCounts.total > 0 ? healingCounts.lucky / healingCounts.total : 0;
                        const healing_crit_lucky_rate = healingCounts.total > 0 ? healingCounts.crit_lucky / healingCounts.total : 0;

                        const totalHealingValue = healingData.total;
                        const realtimeHpsMax = user.realtime_hps_max || 0;
                        const totalHps = user.total_hps || 0;

                        let percentage = 0;
                        let percentageText = '';
                        if (currentSortMode === 'dps' && topHps > 0) {
                            percentage = (totalHps / topHps) * 100;
                            percentageText = `${percentage.toFixed(2)}%`;
                        } else if (currentSortMode === 'realtimeDpsMax' && topHps > 0) {
                            percentage = (realtimeHpsMax / topHps) * 100;
                            percentageText = `${percentage.toFixed(2)}%`;
                        } else if (currentSortMode === 'damage' && totalHealing > 0) {
                            percentage = (totalHealingValue / totalHealing) * 100;
                            percentageText = `${percentage.toFixed(2)}%`;
                        }

                        const row = document.createElement('tr');
                        const backgroundDiv = document.createElement('div');
                        backgroundDiv.className = 'percentage-row-background-hps';
                        backgroundDiv.style.width = `${percentage}%`;
                        row.appendChild(backgroundDiv);
                        
                        const dataColumns = [
                            `${user.id} (${professionName})`,
                            formatNumber(totalHealingValue),
                            `${(healing_crit_rate * 100).toFixed(2)}%`,
                            `${(healing_lucky_rate * 100).toFixed(2)}%`,
                            `${(healing_crit_lucky_rate * 100).toFixed(2)}%`,
                            formatNumber(realtimeHpsMax),
                            totalHps.toFixed(2),
                            `<span class="percentage-text">${percentageText}</span>`
                        ];

                        const tdBlank = document.createElement('td');
                        tdBlank.className = 'trhzb';
                        row.prepend(tdBlank);

                        dataColumns.forEach(html => {
                            const td = document.createElement('td');
                            td.innerHTML = html;
                            row.appendChild(td);
                        });
                        healTable.appendChild(row);
                    }
                }
            } catch (err) {
                console.error('获取数据失败：', err);
            }
        }

        function formatNumber(num) {
            return num ? num.toLocaleString() : '0';
        }

        function sortUserArray(userArray, type) {
            switch (currentSortMode) {
                case 'damage':
                    if (type === 'dps') {
                        userArray.sort((a, b) => (b.total_damage ? b.total_damage.total : 0) - (a.total_damage ? a.total_damage.total : 0));
                    } else if (type === 'hps') {
                        userArray.sort((a, b) => (b.total_healing ? b.total_healing.total : 0) - (a.total_healing ? a.total_healing.total : 0));
                    }
                    break;
                case 'uid':
                    userArray.sort((a, b) => a.id - b.id);
                    break;
                case 'dps':
                    if (type === 'dps') {
                        userArray.sort((a, b) => (b.total_dps === undefined ? -Infinity : b.total_dps) - (a.total_dps === undefined ? -Infinity : a.total_dps));
                    } else if (type === 'hps') {
                        userArray.sort((a, b) => (b.total_hps === undefined ? -Infinity : b.total_hps) - (a.total_hps === undefined ? -Infinity : a.total_hps));
                    }
                    break;
                case 'realtimeDpsMax':
                    if (type === 'dps') {
                        userArray.sort((a, b) => (b.realtime_dps_max === undefined ? -Infinity : b.realtime_dps_max) - (a.realtime_dps_max === undefined ? -Infinity : a.realtime_dps_max));
                    } else if (type === 'hps') {
                        userArray.sort((a, b) => (b.realtime_hps_max === undefined ? -Infinity : b.realtime_hps_max) - (a.realtime_hps_max === undefined ? -Infinity : a.realtime_hps_max));
                    }
                    break;
                default:
                    userArray.sort((a, b) => a.id - b.id);
                    break;
            }
        }

        function changeSortMode(mode) {
            currentSortMode = mode;
            localStorage.setItem('sortMode', currentSortMode);
            updateDropdownButtonText();
            fetchDataAndUpdateTables();
        }

        function updateDropdownButtonText() {
            const btn = document.getElementById('dropdownBtn');
            switch (currentSortMode) {
                case 'damage':
                    btn.textContent = '按总伤害/治疗排序 ▼';
                    break;
                case 'uid':
                    btn.textContent = '按UID排序 ▼';
                    break;
                case 'dps':
                    btn.textContent = '按DPS/HPS排序 ▼';
                    break;
                case 'realtimeDpsMax':
                    btn.textContent = '按最大瞬时排序 ▼';
                    break;
                default:
                    btn.textContent = '排序方式 ▼';
                    break;
            }
        }

        async function clearData() {
            await fetch('/api/clear');
            fetchDataAndUpdateTables();
        }

        // 初始化页面
        setInterval(fetchDataAndUpdateTables, 1000);
        fetchDataAndUpdateTables();
        updateDropdownButtonText();
    </script>
</body>

</html>